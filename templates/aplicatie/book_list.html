{% extends 'aplicatie/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="background-image"></div>
  <h1>Filtrare Cărți</h1>

  <!-- Formularul de filtrare (GET) -->
  <form id="bookFilterForm" method="get" class="mb-4">
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary">Filtrează</button>
    <button type="button" id="resetFilters" class="btn btn-secondary">Resetează filtrele</button>
  </form>

  <!-- Zona care se reîncarcă prin AJAX (partial) -->
  <div id="booksList">
    {% include 'aplicatie/book_list_partial.html' %}
  </div>
</div>

<script>
(function() {
  const form = document.getElementById('bookFilterForm');
  const booksList = document.getElementById('booksList');
  const listUrl = "{% url 'book_list' %}";

  // Helper: face GET AJAX și înlocuiește partial-ul
  function fetchAndReplace(queryParams) {
    let url = listUrl;
    if (queryParams && queryParams.toString()) {
      url += "?" + queryParams.toString();
    }
    return fetch(url, {
      method: "GET",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "Accept": "application/json"
      }
    })
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status} - ${r.statusText}`);
      return r.json();
    })
    .then(data => {
      if (!data.books_html) throw new Error("Răspunsul nu conține books_html");
      booksList.innerHTML = data.books_html;
    });
  }

  // 1) Submit filtrare (AJAX)
  form.addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    // când filtrezi, revii pe pagina 1
    params.delete("page");
    fetchAndReplace(params).catch(err => {
      console.error(err);
      alert("Eroare la filtrare: " + err.message);
    });
  });

  // 2) Reset filtre (AJAX)
  document.getElementById("resetFilters").addEventListener("click", function() {
    form.reset();
    fetchAndReplace(new URLSearchParams()).catch(err => {
      console.error(err);
      alert("Eroare la resetare: " + err.message);
    });
  });

  // 3) Paginare (delegare de eveniment în interiorul #booksList, ca să meargă și după refresh)
  document.addEventListener("click", function(e) {
    const a = e.target.closest("#booksList .pagination a.page-link");
    if (!a) return;
    e.preventDefault();

    // construim query din filtrele curente + page din link
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    const linkUrl = new URL(a.href, window.location.origin);
    const nextPage = linkUrl.searchParams.get("page");
    if (nextPage) params.set("page", nextPage);

    fetchAndReplace(params).catch(err => {
      console.error(err);
      alert("Eroare la paginație: " + err.message);
    });
  });
})();
</script>
{% endblock %}
